version: 2

sources:
  - name: ods_in_customer
    description: |
      ## Customer Domain Source Tables
      
      Customer-related source tables from the ODS_DK_IN schema, ingested via Informatica IDMC.
      These tables contain customer master data, contact information, and personal details
      for the Denmark market.
      
      ### Business Purpose
      - Customer 360 view creation
      - Campaign targeting and segmentation
      - Customer onboarding processes
      - Regulatory reporting (GDPR compliance)
      
      ### Downstream Consumers
      - Campaign Management System
      - Customer Onboarding Application
      - CRM Integration Layer
      - Regulatory Reporting Platform
      
      ### Data Quality Standards
      - Primary key (pk_hash) must be unique and non-null
      - All records must have loaded_at timestamp
      - Soft delete flag (fl_deleted) tracks record lifecycle
      
    database: "{{ var('source_database', 'ods_eu_dev') }}"
    schema: "{{ var('source_schema', 'ODS_DK_IN') }}"
    loader: Informatica IDMC
    loaded_at_field: loaded_at
    
    freshness:
      warn_after: {count: 24, period: hour}
      error_after: {count: 48, period: hour}
    
    meta:
      owner: denmark_data_team
      steward: customer_domain_team
      domain: customer
      market: DK
      pii_contains: true
      gdpr_scope: true
      retention_years: 7
      refresh_cadence: "daily_20:00_CET"
      source_system: IDMC
      data_classification: confidential
      architectural_layer: ods_dk_in
    
    tables:
      - name: customer
        description: |
          ## Customer Master Table
          
          Core customer entity containing business keys and primary attributes.
          This is the **driver table** for customer-related transformations.
          
          ### Business Purpose
          Primary source for customer identification and basic segmentation.
          
          ### Transformation Logic
          - Records are deduplicated using pk_hash (MD5 of business keys)
          - Changes detected via row_hash comparison
          - Soft deletes tracked via fl_deleted flag
          
          ### Standardization Rules
          - customer_name: Trimmed, uppercase
          - customer_type: Mapped to standard values (INDIVIDUAL, CORPORATE)
          - status: Mapped to standard values (ACTIVE, INACTIVE, SUSPENDED)
          
          ### Filtering Criteria
          - Only non-deleted records (fl_deleted = 0) for active customers
          - All records retained for audit purposes
          
          ### Refresh Cadence
          Daily at 20:00 CET via IDMC batch load
          
          ### Downstream Consumers
          - customer_consolidated model
          - customer_summary model
          - Campaign targeting queries
          
        columns:
          - name: pk_hash
            description: |
              **Primary Key - Surrogate Key Hash**
              
              MD5 hash of business key(s) used for deduplication and change detection.
              Generated by IDMC during data load.
            data_type: VARCHAR(32)
            tests:
              - unique
              - not_null
            meta:
              is_primary_key: true
              key_type: PK
              pii: false
              derivation: MD5_HASH
              source_columns: customer_id
              
          - name: row_hash
            description: |
              **Row Hash for Change Detection**
              
              MD5 hash of all non-key columns used to detect data changes.
              When row_hash differs from previous version, record is updated.
            data_type: VARCHAR(32)
            meta:
              is_primary_key: false
              pii: false
              derivation: MD5_HASH
              purpose: change_detection
              
          - name: customer_id
            description: |
              **Business Key - Customer Identifier**
              
              Unique identifier assigned by the source system (CRM).
              Used as the natural key for customer entity resolution.
            data_type: VARCHAR(20)
            tests:
              - not_null
            meta:
              is_business_key: true
              key_type: BK
              pii: false
              source_system: CRM
              
          - name: customer_name
            description: |
              **Customer Full Name**
              
              Full name of the customer (individual or company).
              Standardized to uppercase during transformation.
            data_type: VARCHAR(200)
            meta:
              pii: true
              pii_classification: direct_identifier
              data_classification: confidential
              standardization: uppercase_trim
              
          - name: customer_type
            description: |
              **Customer Category**
              
              Classification of customer type for segmentation purposes.
              
              | Value | Description |
              |-------|-------------|
              | INDIVIDUAL | Personal customer |
              | CORPORATE | Business customer |
            data_type: VARCHAR(20)
            tests:
              - accepted_values:
                  values: ['INDIVIDUAL', 'CORPORATE', 'SMALL_BUSINESS']
            meta:
              pii: false
              accepted_values: INDIVIDUAL, CORPORATE, SMALL_BUSINESS
              
          - name: registration_date
            description: |
              **Customer Registration Date**
              
              Date when the customer was registered in the system.
              Used for customer tenure calculations and cohort analysis.
            data_type: DATE
            meta:
              pii: false
              derivation: source_system
              
          - name: status
            description: |
              **Customer Status**
              
              Current status of the customer account.
              
              | Value | Description |
              |-------|-------------|
              | ACTIVE | Active customer |
              | INACTIVE | Inactive customer |
              | SUSPENDED | Suspended account |
            data_type: VARCHAR(20)
            tests:
              - accepted_values:
                  values: ['ACTIVE', 'INACTIVE', 'SUSPENDED', 'PENDING']
            meta:
              pii: false
              accepted_values: ACTIVE, INACTIVE, SUSPENDED, PENDING
              
          - name: fl_deleted
            description: |
              **Soft Delete Flag**
              
              Binary flag indicating whether the record has been soft deleted.
              - 0 = Active record
              - 1 = Deleted record
              
              Records are never physically deleted; this flag enables audit trail
              and data recovery capabilities.
            data_type: NUMBER(1,0)
            tests:
              - accepted_values:
                  values: [0, 1]
            meta:
              pii: false
              accepted_values: "0 (active), 1 (deleted)"
              purpose: soft_delete_tracking
              
          - name: loaded_at
            description: |
              **Load Timestamp**
              
              Timestamp when the record was loaded into ODS_DK_IN.
              Used for freshness monitoring and incremental processing.
            data_type: TIMESTAMP_NTZ
            tests:
              - not_null
            meta:
              pii: false
              purpose: freshness_tracking
              granularity: timestamp
              
        meta:
          layer: ods_dk_in
          domain: customer
          criticality: high
          sla_hours: 24
          
      - name: address
        description: |
          ## Customer Address Table
          
          Customer address information including primary and secondary addresses.
          Supports multiple address types (HOME, WORK, BILLING, SHIPPING).
          
          ### Business Purpose
          Address information for customer communication and service delivery.
          
          ### Transformation Logic
          - Only active addresses (is_active = TRUE) are included
          - Primary address selected using is_primary flag
          - Multiple addresses ranked by is_primary for consolidation
          
          ### Filtering Criteria
          - is_active = TRUE for active addresses
          - Ranked by is_primary DESC for primary selection
          
        columns:
          - name: pk_hash
            description: Primary key hash for address record
            tests:
              - unique
              - not_null
            meta:
              is_primary_key: true
              key_type: PK
              pii: false
              
          - name: row_hash
            description: Row hash for change detection
            meta:
              pii: false
              purpose: change_detection
              
          - name: address_id
            description: Unique address identifier
            meta:
              key_type: BK
              pii: false
              
          - name: customer_id
            description: Foreign key to customer table
            tests:
              - not_null
            meta:
              key_type: FK
              references: customer.customer_id
              pii: false
              
          - name: address_type
            description: |
              Type of address
              
              | Value | Description |
              |-------|-------------|
              | HOME | Residential address |
              | WORK | Business address |
              | BILLING | Billing address |
              | SHIPPING | Shipping address |
            tests:
              - accepted_values:
                  values: ['HOME', 'WORK', 'BILLING', 'SHIPPING']
            meta:
              pii: false
              
          - name: street_address
            description: Street address line
            meta:
              pii: true
              pii_classification: direct_identifier
              
          - name: city
            description: City name
            meta:
              pii: false
              
          - name: postal_code
            description: Postal/ZIP code
            meta:
              pii: false
              
          - name: country
            description: Country code (ISO 3166-1 alpha-2)
            meta:
              pii: false
              
          - name: is_primary
            description: Flag indicating primary address
            meta:
              pii: false
              
          - name: is_active
            description: Flag indicating active address
            meta:
              pii: false
              
          - name: fl_deleted
            description: Soft delete flag
            tests:
              - accepted_values:
                  values: [0, 1]
            meta:
              pii: false
              
          - name: loaded_at
            description: Load timestamp
            tests:
              - not_null
            meta:
              pii: false
              
        meta:
          layer: ods_dk_in
          domain: customer
          criticality: medium
          
      - name: email
        description: |
          ## Customer Email Table
          
          Customer email addresses with primary and type classification.
          
          ### Business Purpose
          Email communication and campaign targeting.
          
          ### Transformation Logic
          - Only active emails (is_active = TRUE) included
          - Primary email selected using is_primary flag
          
          ### PII Classification
          **Direct Identifier** - Requires GDPR protection
          
        columns:
          - name: pk_hash
            description: Primary key hash
            tests:
              - unique
              - not_null
            meta:
              is_primary_key: true
              key_type: PK
              pii: false
              
          - name: row_hash
            description: Row hash for change detection
            meta:
              pii: false
              
          - name: email_id
            description: Unique email identifier
            meta:
              key_type: BK
              pii: false
              
          - name: customer_id
            description: Foreign key to customer table
            tests:
              - not_null
            meta:
              key_type: FK
              references: customer.customer_id
              pii: false
              
          - name: email_address
            description: |
              **Email Address - PII**
              
              Customer email address for communication.
              Classified as direct identifier under GDPR.
            meta:
              pii: true
              pii_classification: direct_identifier
              data_classification: confidential
              
          - name: email_type
            description: |
              Type of email address
              
              | Value | Description |
              |-------|-------------|
              | PERSONAL | Personal email |
              | WORK | Work email |
            tests:
              - accepted_values:
                  values: ['PERSONAL', 'WORK']
            meta:
              pii: false
              
          - name: is_primary
            description: Flag indicating primary email
            meta:
              pii: false
              
          - name: is_active
            description: Flag indicating active email
            meta:
              pii: false
              
          - name: fl_deleted
            description: Soft delete flag
            tests:
              - accepted_values:
                  values: [0, 1]
            meta:
              pii: false
              
          - name: loaded_at
            description: Load timestamp
            tests:
              - not_null
            meta:
              pii: false
              
        meta:
          layer: ods_dk_in
          domain: customer
          criticality: high
          pii_contains: true
          
      - name: phone
        description: |
          ## Customer Phone Table
          
          Customer phone numbers with type and primary classification.
          
          ### Business Purpose
          Voice communication and SMS campaign targeting.
          
          ### PII Classification
          **Direct Identifier** - Requires GDPR protection
          
        columns:
          - name: pk_hash
            description: Primary key hash
            tests:
              - unique
              - not_null
            meta:
              is_primary_key: true
              key_type: PK
              pii: false
              
          - name: row_hash
            description: Row hash for change detection
            meta:
              pii: false
              
          - name: phone_id
            description: Unique phone identifier
            meta:
              key_type: BK
              pii: false
              
          - name: customer_id
            description: Foreign key to customer table
            tests:
              - not_null
            meta:
              key_type: FK
              references: customer.customer_id
              pii: false
              
          - name: phone_number
            description: |
              **Phone Number - PII**
              
              Customer phone number in E.164 format.
              Classified as direct identifier under GDPR.
            meta:
              pii: true
              pii_classification: direct_identifier
              data_classification: confidential
              
          - name: phone_type
            description: |
              Type of phone number
              
              | Value | Description |
              |-------|-------------|
              | MOBILE | Mobile phone |
              | LANDLINE | Landline phone |
            tests:
              - accepted_values:
                  values: ['MOBILE', 'LANDLINE']
            meta:
              pii: false
              
          - name: is_primary
            description: Flag indicating primary phone
            meta:
              pii: false
              
          - name: is_active
            description: Flag indicating active phone
            meta:
              pii: false
              
          - name: fl_deleted
            description: Soft delete flag
            tests:
              - accepted_values:
                  values: [0, 1]
            meta:
              pii: false
              
          - name: loaded_at
            description: Load timestamp
            tests:
              - not_null
            meta:
              pii: false
              
        meta:
          layer: ods_dk_in
          domain: customer
          criticality: high
          pii_contains: true
          
      - name: personal_information
        description: |
          ## Customer Personal Information Table
          
          Sensitive personal details including date of birth and national ID.
          
          ### Business Purpose
          Age verification, identity validation, and regulatory compliance.
          
          ### PII Classification
          **Sensitive PII** - Requires enhanced GDPR protection
          
          ### Data Governance
          - Access restricted to authorized personnel only
          - Encryption required at rest and in transit
          - Audit logging mandatory for all access
          
        columns:
          - name: pk_hash
            description: Primary key hash
            tests:
              - unique
              - not_null
            meta:
              is_primary_key: true
              key_type: PK
              pii: false
              
          - name: row_hash
            description: Row hash for change detection
            meta:
              pii: false
              
          - name: customer_id
            description: Foreign key to customer table
            tests:
              - not_null
            meta:
              key_type: FK
              references: customer.customer_id
              pii: false
              
          - name: date_of_birth
            description: |
              **Date of Birth - Sensitive PII**
              
              Customer date of birth for age verification.
              Used for age-based product eligibility and marketing compliance.
            meta:
              pii: true
              pii_classification: sensitive
              data_classification: restricted
              
          - name: national_id
            description: |
              **National ID - Sensitive PII**
              
              Danish CPR number (Civil Registration Number).
              Used for identity verification and regulatory reporting.
              
              **Handling Requirements:**
              - Never expose in reports or dashboards
              - Mask in non-production environments
              - Encrypt in transit and at rest
            meta:
              pii: true
              pii_classification: sensitive
              data_classification: restricted
              masking_required: true
              
          - name: gender
            description: |
              Gender classification
              
              | Value | Description |
              |-------|-------------|
              | M | Male |
              | F | Female |
              | U | Unknown/Not specified |
            tests:
              - accepted_values:
                  values: ['M', 'F', 'U']
            meta:
              pii: false
              
          - name: fl_deleted
            description: Soft delete flag
            tests:
              - accepted_values:
                  values: [0, 1]
            meta:
              pii: false
              
          - name: loaded_at
            description: Load timestamp
            tests:
              - not_null
            meta:
              pii: false
              
        meta:
          layer: ods_dk_in
          domain: customer
          criticality: critical
          pii_contains: true
          data_classification: restricted
